<!doctype html><html lang=zh-cn><head><title></title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.87ecd420aa4299c8e4b21123c5360ef38ce9d1370c88559d014914f4a65e6b89.css integrity="sha256-h+zUIKpCmcjkshEjxTYO84zp0TcMiFWdAUkU9KZea4k="><link rel=icon type=image/png href=/images/favicon_hu8376fd15465fef26ffe66b6bcf0ca686_13669_42x0_resize_box_3.png><meta property="og:title" content><meta property="og:description" content="Go 原子操作 #go #golang #atomic #原子操作
互斥锁跟原子操作的区别 在并发编程里，Go 语言 sync 包里的同步原语 Mutex 是我们经常用来保证并发安全的，但是他跟 atomic 包在使用目的和底层实现上都不一样：
&mdash;&ndash; 互斥锁 原子操作 使用目的 保护一段逻辑 保护一个变量 底层实现 由操作系统的调度器实现 由底层硬件指令直接提供支持 相对性能 低 高 Mutex 由操作系统的调度器实现，而 atomic 包中的原子操作则由底层硬件指令直接提供支持，这些指令在执行的过程中是不允许中断的，因此原子操作可以在 lock-free 的情况下保证并发安全，并且它的性能也能做到随 CPU 个数的增多而线性扩展。
对于一个变量更新的保护，原子操作通常会更有效率，并且更能利用计算机多核的优势。
性能对比测试 互斥锁性能测试 使用 sync 包下面互斥锁的多线程加法操作
func syncAdd(param int64) int64 { var wg sync.WaitGroup lock := sync.Mutex{} for i := 0; i < 10; i++ { wg.Add(1) go func() { for i := 0; i < 1000000; i++ { lock."><meta property="og:type" content="article"><meta property="og:url" content="https://ormissia.github.io/notes/my_notes/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E8%AF%AD%E8%A8%80/go/go-%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"><meta property="article:section" content="notes"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Go 原子操作 #go #golang #atomic #原子操作
互斥锁跟原子操作的区别 在并发编程里，Go 语言 sync 包里的同步原语 Mutex 是我们经常用来保证并发安全的，但是他跟 atomic 包在使用目的和底层实现上都不一样：
&mdash;&ndash; 互斥锁 原子操作 使用目的 保护一段逻辑 保护一个变量 底层实现 由操作系统的调度器实现 由底层硬件指令直接提供支持 相对性能 低 高 Mutex 由操作系统的调度器实现，而 atomic 包中的原子操作则由底层硬件指令直接提供支持，这些指令在执行的过程中是不允许中断的，因此原子操作可以在 lock-free 的情况下保证并发安全，并且它的性能也能做到随 CPU 个数的增多而线性扩展。
对于一个变量更新的保护，原子操作通常会更有效率，并且更能利用计算机多核的优势。
性能对比测试 互斥锁性能测试 使用 sync 包下面互斥锁的多线程加法操作
func syncAdd(param int64) int64 { var wg sync.WaitGroup lock := sync.Mutex{} for i := 0; i < 10; i++ { wg.Add(1) go func() { for i := 0; i < 1000000; i++ { lock."><script>theme=localStorage.getItem("darkmode:color-scheme")||"system",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-notes kind-page" data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/ormissia_hu763a76473558eea2a316ef50b45aaecf_966068_42x0_resize_box_3.png id=logo alt=Logo>
Ormissia's Blog</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-toggle=collapse data-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/#home>主页</a></li><li class=nav-item><a class=nav-link href=/#about>技能</a></li><li class=nav-item><a class=nav-link href=/#recent-posts>最近</a></li><li class=nav-item><a class=nav-link href=/#education>历程</a></li><li class=nav-item><a class=nav-link href=/#projects>项目</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>更多的</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/#achievements>成就</a></div></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>博文</a></li><li class=nav-item><a class=nav-link id=note-link href=/notes>笔记</a></li><li class=nav-item><a class=nav-link href=https://github.com/ormissia>GitHub</a></li></ul></div></div><img src=/images/ormissia_hu763a76473558eea2a316ef50b45aaecf_966068_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/ormissia_hu763a76473558eea2a316ef50b45aaecf_966068_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=搜索 data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/notes data-filter=all>笔记</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/notes/go/> Go</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/go/basic/> Basics</a><ul><li><a class=list-link href=/notes/go/basic/basic/ title=Basic>Basic</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/go/advance/> Advance</a><ul><li><a class=list-link href=/notes/go/advance/time/ title=time>time</a></li><li><a class=list-link href=/notes/go/advance/gomod/ title="go mod">go mod</a></li><li><a class=list-link href=/notes/go/advance/chan/ title="go chan">go chan</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/go/algorithm/> Algorithm</a><ul><li><a class=list-link href=/notes/go/algorithm/basic/ title=Basic>Basic</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/java/> Java</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/java/basic/> Basics</a><ul><li><a class=list-link href=/notes/java/basic/basic_type/ title="Basic Types">Basic Types</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/scala/> Scala</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/scala/basic/> Basic</a><ul><li><a class=list-link href=/notes/scala/basic/basic_type/ title="Basic Types">Basic Types</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/python/> Python</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/python/basic/> Basic</a><ul><li><a class=list-link href=/notes/python/basic/basic/ title=Basic>Basic</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/js/> JavaScript</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/js/basic/> Basic</a><ul><li><a class=list-link href=/notes/js/basic/basic/ title=Basic>Basic</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/sql/> SQL</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/sql/dml/> DML</a><ul><li><a class=list-link href=/notes/sql/dml/dml/ title="SQL DML">SQL DML</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/linux/> Linux</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/linux/shell/> Shell</a><ul><li><a class=list-link href=/notes/linux/shell/basic/ title=Basic>Basic</a></li><li><a class=list-link href=/notes/linux/shell/advance/ title=Advance>Advance</a></li><li><a class=list-link href=/notes/linux/shell/vi/ title=vi>vi</a></li><li><a class=list-link href=/notes/linux/shell/script/ title=Script>Script</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/linux/system/> System</a><ul><li><a class=list-link href=/notes/linux/system/system/ title=Memory>Memory</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/hbase/> Hbase</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/hbase/shell/> Shell</a><ul><li><a class=list-link href=/notes/hbase/shell/basic/ title=Basic>Basic</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/kafka/> Kafka</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/kafka/shell/> Shell</a><ul><li><a class=list-link href=/notes/kafka/shell/basic/ title=Basic>Basic</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class="content container-fluid" id=content><div class="container-fluid note-card-holder" id=note-card-holder><h1 id=go-原子操作>Go 原子操作</h1><p>#go #golang #atomic #原子操作</p><h2 id=互斥锁跟原子操作的区别>互斥锁跟原子操作的区别</h2><p>在并发编程里，<code>Go</code> 语言 <code>sync</code> 包里的同步原语 <code>Mutex</code> 是我们经常用来保证并发安全的，但是他跟 <code>atomic</code> 包在使用目的和底层实现上都不一样：</p><table><thead><tr><th>&mdash;&ndash;</th><th>互斥锁</th><th>原子操作</th></tr></thead><tbody><tr><td>使用目的</td><td>保护一段逻辑</td><td>保护一个变量</td></tr><tr><td>底层实现</td><td>由操作系统的调度器实现</td><td>由底层硬件指令直接提供支持</td></tr><tr><td>相对性能</td><td>低</td><td>高</td></tr></tbody></table><p><code>Mutex</code> 由操作系统的调度器实现，而 <code>atomic</code> 包中的原子操作则由底层硬件指令直接提供支持，这些指令在执行的过程中是不允许中断的，因此原子操作可以在 <code>lock-free</code> 的情况下保证并发安全，并且它的性能也能做到随 <code>CPU</code> 个数的增多而线性扩展。</p><blockquote><p><strong>对于一个变量更新的保护，原子操作通常会更有效率，并且更能利用计算机多核的优势。</strong></p></blockquote><h2 id=性能对比测试>性能对比测试</h2><h3 id=互斥锁性能测试>互斥锁性能测试</h3><blockquote><p>使用 <code>sync</code> 包下面互斥锁的多线程加法操作</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>syncAdd</span>(<span style=color:#a6e22e>param</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int64</span> {  
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>  
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>lock</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>{}  
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)  
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {  
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>1000000</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Lock</span>()  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>param</span><span style=color:#f92672>++</span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Unlock</span>()  
</span></span><span style=display:flex><span>         }  
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()  
</span></span><span style=display:flex><span>      }()  
</span></span><span style=display:flex><span>   }  
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()  
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>param</span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Benchmark</code> 测试方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkSync</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {  
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>flag</span> <span style=color:#f92672>:=</span> int64(<span style=color:#ae81ff>0</span>)  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syncAdd</span>(<span style=color:#a6e22e>flag</span>)  
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>10000000</span> {  
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;calculate result err: %d\n&#34;</span>, <span style=color:#a6e22e>res</span>)  
</span></span><span style=display:flex><span>      }  
</span></span><span style=display:flex><span>   }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>测试结果：</p><blockquote><p>根据运行环境和硬件性能会有所不同，这里是在相同环境下的对比</p></blockquote><ul><li>第一次</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>goos: darwin
</span></span><span style=display:flex><span>goarch: arm64
</span></span><span style=display:flex><span>pkg: wire/atomic_test
</span></span><span style=display:flex><span>BenchmarkSync
</span></span><span style=display:flex><span>BenchmarkSync-8 <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>862741542</span> ns/op
</span></span><span style=display:flex><span>PASS
</span></span></code></pre></div><ul><li>第二次</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>goos: darwin
</span></span><span style=display:flex><span>goarch: arm64
</span></span><span style=display:flex><span>pkg: wire/atomic_test
</span></span><span style=display:flex><span>BenchmarkSync
</span></span><span style=display:flex><span>BenchmarkSync-8 <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>875432729</span> ns/op
</span></span><span style=display:flex><span>PASS
</span></span></code></pre></div><ul><li>第三次</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>goos: darwin
</span></span><span style=display:flex><span>goarch: arm64
</span></span><span style=display:flex><span>pkg: wire/atomic_test
</span></span><span style=display:flex><span>BenchmarkSync
</span></span><span style=display:flex><span>BenchmarkSync-8 <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>836373292</span> ns/op
</span></span><span style=display:flex><span>PASS
</span></span></code></pre></div><p>三次取平均：<code>(862741542 + 875432729 + 836373292) / 3 = 858182521 ns/op</code></p><h3 id=原子操作性能测试>原子操作性能测试</h3><blockquote><p>使用 <code>atomic</code> 包下面原子操作的多线程加法操作</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>atomicAdd</span>(<span style=color:#a6e22e>param</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int64</span> {  
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>  
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)  
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {  
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>1000000</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>param</span>, <span style=color:#ae81ff>1</span>)  
</span></span><span style=display:flex><span>         }  
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()  
</span></span><span style=display:flex><span>      }()  
</span></span><span style=display:flex><span>   }  
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()  
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>param</span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Benchmark 测试方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkAtomic</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {  
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>flag</span> <span style=color:#f92672>:=</span> int64(<span style=color:#ae81ff>0</span>)  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atomicAdd</span>(<span style=color:#a6e22e>flag</span>)  
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>10000000</span> {  
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;calculate result err: %d\n&#34;</span>, <span style=color:#a6e22e>res</span>)  
</span></span><span style=display:flex><span>      }  
</span></span><span style=display:flex><span>   }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>测试结果：</p><blockquote><p>根据运行环境和硬件性能会有所不同，这里是在相同环境下的对比</p></blockquote><ul><li>第一次</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>goos: darwin
</span></span><span style=display:flex><span>goarch: arm64
</span></span><span style=display:flex><span>pkg: wire/atomic_test
</span></span><span style=display:flex><span>BenchmarkAtomic
</span></span><span style=display:flex><span>BenchmarkAtomic-8 <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>359013958</span> ns/op
</span></span><span style=display:flex><span>PASS
</span></span></code></pre></div><ul><li>第二次</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>goos: darwin
</span></span><span style=display:flex><span>goarch: arm64
</span></span><span style=display:flex><span>pkg: wire/atomic_test
</span></span><span style=display:flex><span>BenchmarkAtomic
</span></span><span style=display:flex><span>BenchmarkAtomic-8 <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>359734514</span> ns/op
</span></span><span style=display:flex><span>PASS
</span></span></code></pre></div><ul><li>第三次</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>goos: darwin
</span></span><span style=display:flex><span>goarch: arm64
</span></span><span style=display:flex><span>pkg: wire/atomic_test
</span></span><span style=display:flex><span>BenchmarkAtomic
</span></span><span style=display:flex><span>BenchmarkAtomic-8 <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>359007542</span> ns/op
</span></span><span style=display:flex><span>PASS
</span></span></code></pre></div><p>三次取平均：<code>(359013958 + 359734514 + 359007542) / 3 = 359252004 ns/op</code></p><h3 id=测试结果对比>测试结果对比</h3><p>根据测试结果数据使用互斥锁做累加每次循环耗时 <code>858182521 ns</code>，而使用原子操作做累加每次耗时 <code>359252004 ns</code>。</p><p>这也印证了之前说过的：<strong>互斥锁适用于来保护一段逻辑，原子操作适用于于对一个变量的更新保护。</strong></p><h2 id=原理浅析>原理浅析</h2><p>参考： <a href=https://ormissia.github.io/posts/knowledge/2001-go/006-atomic/#%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0 target=_blank rel=noopener>互斥锁跟原子操作的区别-底层实现</a></p><h2 id=参考链接>参考链接</h2><ul><li><a href=https://zhuanlan.zhihu.com/p/412666957 target=_blank rel=noopener>Golang五种原子性操作的用法详解</a></li></ul></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>联系方式:</h5><ul><li><span>QQ: </span><span>1432050813</span></li><li><a href=mailto:ormissia@outlook.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>ormissia@outlook.com</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>免责声明:</strong> 老铁看到底了，要负责的哦</p></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.dd14ce5884a636a7014ae8dc2953b8089e2c54e6449da331e2726c712c81c910.js integrity="sha256-3RTOWISmNqcBSujcKVO4CJ4sVOZEnaMx4nJscSyByRA=" defer></script></body></html>