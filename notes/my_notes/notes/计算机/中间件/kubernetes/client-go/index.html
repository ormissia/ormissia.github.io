<!doctype html><html lang=zh-cn><head><title></title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.87ecd420aa4299c8e4b21123c5360ef38ce9d1370c88559d014914f4a65e6b89.css integrity="sha256-h+zUIKpCmcjkshEjxTYO84zp0TcMiFWdAUkU9KZea4k="><link rel=icon type=image/png href=/images/favicon_hu8376fd15465fef26ffe66b6bcf0ca686_13669_42x0_resize_box_3.png><meta property="og:title" content><meta property="og:description" content="client-go #k8s #kubernetes #clientgo #apiserver #go #golang
基础使用 源码仓库 依赖引入 go get k8s.io/client-go@latest go get k8s.io/client-go@v0.20.4 client-go 客户端 架构 图片来源
客户端组件 Reflector：反射器，定义在 type Reflector inside package cache 中，监视 Kubernetes API 的指定资源类型（种类）。完成此操作的函数是 ListAndWatch。监视可以用于内置资源，也可以用于自定义资源。当 Reflector 通过 watch API 接收到关于新资源实例存在的通知时，它使用相应的 listing API 获取新创建的对象并将其放入 watchHandler 函数内的 Delta Fifo 队列中。 Informer：在 base controller inside package cache 中定义的 Informer 从 Delta Fifo 队列中弹出对象。完成此操作的函数是 processLoop。这个基本控制器的工作是保存对象供以后检索，并调用我们的控制器将对象传递给它。 Indexer：索引器提供对象的索引功能。在 type Indexer inside package cache 中定义。一个典型的索引用例是基于对象标签创建索引。Indexer 可以维护基于多个索引函数的索引。索引器使用线程安全的数据存储来存储对象及其键。type Store inside package cache 中定义了一个名为 MetaNamespaceKeyFunc 的默认函数，它生成 <namespace>/<name> 的键作为该对象的组合。 自定义控制器组件 Informer reference：这是对知道如何使用自定义资源对象的 Informer 实例的引用。自定义控制器代码需要创建适当的 Informer。 Indexer reference：这是对知道如何使用自定义资源对象的 Indexer 实例的引用。自定义控制器代码需要创建它。将使用此引用来检索对象以供以后处理。 client-go 中的 base controller 提供了 NewIndexerInformer 函数来创建 Informer 和 Indexer。在代码中，可以直接调用此函数或使用工厂方法来创建Informer。"><meta property="og:type" content="article"><meta property="og:url" content="https://ormissia.github.io/notes/my_notes/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E4%B8%AD%E9%97%B4%E4%BB%B6/kubernetes/client-go/"><meta property="article:section" content="notes"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="client-go #k8s #kubernetes #clientgo #apiserver #go #golang
基础使用 源码仓库 依赖引入 go get k8s.io/client-go@latest go get k8s.io/client-go@v0.20.4 client-go 客户端 架构 图片来源
客户端组件 Reflector：反射器，定义在 type Reflector inside package cache 中，监视 Kubernetes API 的指定资源类型（种类）。完成此操作的函数是 ListAndWatch。监视可以用于内置资源，也可以用于自定义资源。当 Reflector 通过 watch API 接收到关于新资源实例存在的通知时，它使用相应的 listing API 获取新创建的对象并将其放入 watchHandler 函数内的 Delta Fifo 队列中。 Informer：在 base controller inside package cache 中定义的 Informer 从 Delta Fifo 队列中弹出对象。完成此操作的函数是 processLoop。这个基本控制器的工作是保存对象供以后检索，并调用我们的控制器将对象传递给它。 Indexer：索引器提供对象的索引功能。在 type Indexer inside package cache 中定义。一个典型的索引用例是基于对象标签创建索引。Indexer 可以维护基于多个索引函数的索引。索引器使用线程安全的数据存储来存储对象及其键。type Store inside package cache 中定义了一个名为 MetaNamespaceKeyFunc 的默认函数，它生成 <namespace>/<name> 的键作为该对象的组合。 自定义控制器组件 Informer reference：这是对知道如何使用自定义资源对象的 Informer 实例的引用。自定义控制器代码需要创建适当的 Informer。 Indexer reference：这是对知道如何使用自定义资源对象的 Indexer 实例的引用。自定义控制器代码需要创建它。将使用此引用来检索对象以供以后处理。 client-go 中的 base controller 提供了 NewIndexerInformer 函数来创建 Informer 和 Indexer。在代码中，可以直接调用此函数或使用工厂方法来创建Informer。"><script>theme=localStorage.getItem("darkmode:color-scheme")||"system",theme=="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-notes kind-page" data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/ormissia_hu763a76473558eea2a316ef50b45aaecf_966068_42x0_resize_box_3.png id=logo alt=Logo>
Ormissia's Blog</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-toggle=collapse data-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/#home>主页</a></li><li class=nav-item><a class=nav-link href=/#about>技能</a></li><li class=nav-item><a class=nav-link href=/#recent-posts>最近</a></li><li class=nav-item><a class=nav-link href=/#education>历程</a></li><li class=nav-item><a class=nav-link href=/#projects>项目</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>更多的</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/#achievements>成就</a></div></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>博文</a></li><li class=nav-item><a class=nav-link id=note-link href=/notes>笔记</a></li><li class=nav-item><a class=nav-link href=https://github.com/ormissia>GitHub</a></li></ul></div></div><img src=/images/ormissia_hu763a76473558eea2a316ef50b45aaecf_966068_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/ormissia_hu763a76473558eea2a316ef50b45aaecf_966068_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=搜索 data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/notes data-filter=all>笔记</a></li><div class=subtree><li><i data-feather=plus-circle></i><a class=list-link href=/notes/go/> Go</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/go/basic/> Basics</a><ul><li><a class=list-link href=/notes/go/basic/basic/ title=Basic>Basic</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/go/advance/> Advance</a><ul><li><a class=list-link href=/notes/go/advance/time/ title=time>time</a></li><li><a class=list-link href=/notes/go/advance/gomod/ title="go mod">go mod</a></li><li><a class=list-link href=/notes/go/advance/chan/ title="go chan">go chan</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/go/algorithm/> Algorithm</a><ul><li><a class=list-link href=/notes/go/algorithm/basic/ title=Basic>Basic</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/java/> Java</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/java/basic/> Basics</a><ul><li><a class=list-link href=/notes/java/basic/basic_type/ title="Basic Types">Basic Types</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/scala/> Scala</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/scala/basic/> Basic</a><ul><li><a class=list-link href=/notes/scala/basic/basic_type/ title="Basic Types">Basic Types</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/python/> Python</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/python/basic/> Basic</a><ul><li><a class=list-link href=/notes/python/basic/basic/ title=Basic>Basic</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/js/> JavaScript</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/js/basic/> Basic</a><ul><li><a class=list-link href=/notes/js/basic/basic/ title=Basic>Basic</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/sql/> SQL</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/sql/dml/> DML</a><ul><li><a class=list-link href=/notes/sql/dml/dml/ title="SQL DML">SQL DML</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/linux/> Linux</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/linux/shell/> Shell</a><ul><li><a class=list-link href=/notes/linux/shell/basic/ title=Basic>Basic</a></li><li><a class=list-link href=/notes/linux/shell/advance/ title=Advance>Advance</a></li><li><a class=list-link href=/notes/linux/shell/vi/ title=vi>vi</a></li><li><a class=list-link href=/notes/linux/shell/script/ title=Script>Script</a></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/linux/system/> System</a><ul><li><a class=list-link href=/notes/linux/system/system/ title=Memory>Memory</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/hbase/> Hbase</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/hbase/shell/> Shell</a><ul><li><a class=list-link href=/notes/hbase/shell/basic/ title=Basic>Basic</a></li></ul></li></ul></li><li><i data-feather=plus-circle></i><a class=list-link href=/notes/kafka/> Kafka</a><ul><li><i data-feather=plus-circle></i><a class=list-link href=/notes/kafka/shell/> Shell</a><ul><li><a class=list-link href=/notes/kafka/shell/basic/ title=Basic>Basic</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class="content container-fluid" id=content><div class="container-fluid note-card-holder" id=note-card-holder><h1 id=client-go>client-go</h1><p>#k8s #kubernetes #clientgo #apiserver #go #golang</p><h2 id=基础使用>基础使用</h2><h3 id=源码仓库httpsgithubcomkubernetesclient-go><a href=https://github.com/kubernetes/client-go target=_blank rel=noopener>源码仓库</a></h3><h3 id=依赖引入>依赖引入</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go get k8s.io/client-go@latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>go get k8s.io/client-go@v0.20.4
</span></span></code></pre></div><h2 id=client-go-客户端>client-go 客户端</h2><h3 id=架构>架构</h3><p><img src=client-go-controller-interaction.jpeg alt></p><p><a href=https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md target=_blank rel=noopener>图片来源</a></p><h4 id=客户端组件>客户端组件</h4><ul><li><code>Reflector</code>：反射器，定义在 <a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/reflector.go target=_blank rel=noopener>type <em>Reflector</em> inside package <em>cache</em></a> 中，监视 <code>Kubernetes API</code> 的指定资源类型（种类）。完成此操作的函数是 <code>ListAndWatch</code>。监视可以用于内置资源，也可以用于自定义资源。当 <code>Reflector</code> 通过 <code>watch API</code> 接收到关于新资源实例存在的通知时，它使用相应的 <code>listing API</code> 获取新创建的对象并将其放入 <code>watchHandler</code> 函数内的 <code>Delta Fifo</code> 队列中。</li><li><code>Informer</code>：在 <a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/controller.go target=_blank rel=noopener>base controller inside package <em>cache</em></a> 中定义的 <code>Informer</code> 从 <code>Delta Fifo</code> 队列中弹出对象。完成此操作的函数是 <code>processLoop</code>。这个基本控制器的工作是保存对象供以后检索，并调用我们的控制器将对象传递给它。</li><li><code>Indexer</code>：索引器提供对象的索引功能。在 <a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/index.go target=_blank rel=noopener>type <em>Indexer</em> inside package <em>cache</em></a> 中定义。一个典型的索引用例是基于对象标签创建索引。<code>Indexer</code> 可以维护基于多个索引函数的索引。索引器使用线程安全的数据存储来存储对象及其键。<a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/store.go target=_blank rel=noopener>type <em>Store</em> inside package <em>cache</em></a> 中定义了一个名为 <code>MetaNamespaceKeyFunc</code> 的默认函数，它生成 <code>&lt;namespace>/&lt;name></code> 的键作为该对象的组合。</li></ul><h4 id=自定义控制器组件>自定义控制器组件</h4><ul><li><code>Informer reference</code>：这是对知道如何使用自定义资源对象的 Informer 实例的引用。自定义控制器代码需要创建适当的 <code>Informer</code>。</li><li><code>Indexer reference</code>：这是对知道如何使用自定义资源对象的 <code>Indexer</code> 实例的引用。自定义控制器代码需要创建它。将使用此引用来检索对象以供以后处理。</li></ul><blockquote><p><code>client-go</code> 中的 <code>base controller</code> 提供了 <code>NewIndexerInformer</code> 函数来创建 <code>Informer</code> 和 <code>Indexer</code>。在代码中，可以<a href=https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go#L174 target=_blank rel=noopener>直接调用此函数</a>或<a href=https://github.com/kubernetes/sample-controller/blob/master/main.go#L61 target=_blank rel=noopener>使用工厂方法来创建<code>Informer</code></a>。</p></blockquote><ul><li><code>Resource Event Handlers</code>：这些是回调函数，当 <code>Informer</code> 想要将对象传递给控制器时将调用这些回调函数。编写这些函数的典型模式是获取分派对象的键并将该键放入工作队列中以供进一步处理。</li><li><code>Work queue:</code>：这是在控制器代码中创建的队列，用于将对象的传递与其处理分离。编写资源事件处理程序函数以提取已交付对象的键并将其添加到工作队列中。</li><li><code>Process Item</code>：这是在代码中创建的函数，用于处理工作队列中的项目。可以有一个或多个其他函数进行实际处理。这些函数通常会使用 <a href=https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go#L73 target=_blank rel=noopener>Indexer reference</a> 或 <code>Listing wrapper</code> 来检索与键对应的对象。</li></ul><h3 id=组件>组件</h3><p><code>client-go</code> 共提供了 4 种与 <code>Kubernetes APIServer</code> 交互的客户端。分别是 <code>RESTClient</code>、<code>DiscoveryClient</code>、<code>ClientSet</code>、<code>DynamicClient</code>。</p><ul><li><code>RESTClient</code>：最基础的客户端，主要是对 <code>HTTP</code> 请求进行了封装，支持 <code>Json</code> 和 <code>Protobuf</code> 格式的数据。</li><li><code>DiscoveryClient</code>：发现客户端，负责发现 <code>APIServer</code> 支持的资源组、资源版本和资源信息的。</li><li><code>ClientSet</code>：负责操作 <code>Kubernetes</code> 内置的资源对象，例如：<code>Pod</code>、<code>Service</code>等。</li><li><code>DynamicClient</code>：动态客户端，可以对任意的 <code>Kubernetes</code> 资源对象进行通用操作，包括 <code>CRD</code>。</li></ul><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph TD

A[DiscoveryClient]
B[ClientSet]
C[DynamicClient]
D[RESTClient]
E[net/http]
F[Kubernetes APIServer]

    A --&gt; D
    B --&gt; D
    C --&gt; D

	D --&gt; E
	E --&gt; F
</code></pre></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>联系方式:</h5><ul><li><span>QQ: </span><span>1432050813</span></li><li><a href=mailto:ormissia@outlook.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>ormissia@outlook.com</span></a></li></ul></div></div></div><hr><div class=container><p id=disclaimer><strong>免责声明:</strong> 老铁看到底了，要负责的哦</p></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.dd14ce5884a636a7014ae8dc2953b8089e2c54e6449da331e2726c712c81c910.js integrity="sha256-3RTOWISmNqcBSujcKVO4CJ4sVOZEnaMx4nJscSyByRA=" defer></script></body></html>