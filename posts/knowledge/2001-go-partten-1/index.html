<!doctype html><html>
<head>
<title>Go 惯用模式：函数选项模式</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<link rel=stylesheet href=/css/bootstrap.min.css>
<link rel=stylesheet href=/css/layouts/main.css>
<link rel=stylesheet href=/css/navigators/navbar.css>
<link rel=stylesheet href=/css/plyr.css>
<link rel=stylesheet href=/css/flag-icon.min.css>
<link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css>
<link rel=icon type=image/png href=/images/favicon_hu8376fd15465fef26ffe66b6bcf0ca686_13669_42x0_resize_box_3.png>
<meta property="og:title" content="Go 惯用模式：函数选项模式">
<meta property="og:description" content="作为 Golang 开发者，遇到的许多问题之一就是尝试将函数的参数设置成可选项。这是一个十分常见的场景，您可以使用一些已经设置默认配置和开箱即用的对象，同时您也可以使用一些更为详细的配置。
 问题出发点 对于许多编程语言来说，这很容易。在 C 语言家族中，您可以提供具有同一个函数但是不同参数的多个版本；在 PHP 之类的语言中，您可以为参数提供默认值，并在调用该方法时将其忽略。但是在 Golang 中，上述的做法都不可以使用。那么您如何创建具有一些其他配置的函数，用户可以根据他的需求（但是仅在需要时）指定一些额外的配置。
有很多的方法可以做到这一点，但是大多数方法都不是尽如人意，要么需要在服务端的代码中进行大量额外的检查和验证，要么通过传入他们不关心的其他参数来为客户端进行额外的工作。
下面我将会介绍一些不同的选项，然后为其说明为什么每个选项都不理想，接着我们会逐步构建自己的方式来作为最终的干净解决方案：函数选项模式。
让我们来看一个例子。比方说，这里有一个叫做StuffClient的服务，它能够胜任一些工作，同时还具有两个配置选项（超时和重试）。
type StuffClient interface { DoStuff() error } type stuffClient struct { conn Connection timeout int retries int } 这是个私有的结构体，因此我们应该为它提供某种构造函数：
func NewStuffClient(conn Connection, timeout, retries int) StuffClient { return &stuffClient{ conn: conn, timeout: timeout, retries: retries, } } 嗯，但是现在我们每次调用NewStuffClient函数时都要提供timeout和retries。因为在大多数情况下，我们只想使用默认值，我们无法使用不同参数数量带定义多个版本的NewStuffClient，否则我们会得到一个类似NewStuffClient redeclared in this block编译错误。
一个可选方案是创建另一个具有不同名称的构造函数，例如：
func NewStuffClient(conn Connection) StuffClient { return &stuffClient{ conn: conn, timeout: DEFAULT_TIMEOUT, retries: DEFAULT_RETRIES, } } func NewStuffClientWithOptions(conn Connection, timeout, retries int) StuffClient { return &stuffClient{ conn: conn, timeout: timeout, retries: retries, } } 但是这么做的话有点蹩脚。我们可以做得更好，如果我们传入了一个配置对象呢:">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ormissia.github.io/posts/knowledge/2001-go-partten-1/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-07-22T11:13:56+08:00">
<meta property="article:modified_time" content="2021-07-22T11:13:56+08:00">
<meta name=description content="Go 惯用模式：函数选项模式">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css>
<link rel=stylesheet href=/css/layouts/single.css>
<link rel=stylesheet href=/css/navigators/sidebar.css>
<link rel=stylesheet href=/css/style.css>
</head>
<body data-spy=scroll data-target=#TableOfContents data-offset=80>
<div class="container-fluid bg-dimmed wrapper">
<nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
<div class=container>
<button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span>
</button>
<a class=navbar-brand href=/>
<img src=/images/ormissia_hu763a76473558eea2a316ef50b45aaecf_966068_42x0_resize_box_3.png alt=Logo>
Ormissia's Blog</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse lang-selector" id=top-nav-items>
<ul class="navbar-nav ml-auto">
</ul>
</div>
</div>
<img src=/images/ormissia_hu763a76473558eea2a316ef50b45aaecf_966068_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/ormissia_hu763a76473558eea2a316ef50b45aaecf_966068_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo">
</nav>
<section class=sidebar-section id=sidebar-section>
<div class=sidebar-holder>
<div class=sidebar id=sidebar>
<form class=mx-auto method=get action=/search>
<input type=text name=keyword placeholder=Search data-search id=search-box>
</form>
<div class=sidebar-tree>
<ul class=tree id=tree>
<li id=list-heading><a href=/posts data-filter=all>博文</a></li>
<div class=subtree>
<li>
<i class="fas fa-minus-circle"></i><a class=active href=/posts/knowledge/>知识积累</a>
<ul class=active>
<li><a class=active href=/posts/knowledge/2001-go-partten-1/ title=函数选项模式>函数选项模式</a></li>
<li><a href=/posts/knowledge/2002-go-param-verify/ title=实体参数校验>实体参数校验</a></li>
<li><a href=/posts/knowledge/2003-go-reflect/ title=Golang反射>Golang反射</a></li>
<li><a href=/posts/knowledge/2004-go-pprof/ title=pprof>pprof</a></li>
<li><a href=/posts/knowledge/2005-go-tag/ title="Golang struct tag">Golang struct tag</a></li>
<li><a href=/posts/knowledge/2006-hadoop-env/ title=Hadoop生态组件>Hadoop生态组件</a></li>
<li><a href=/posts/knowledge/2007-hadoop-hdfs/ title=HDFS基础知识>HDFS基础知识</a></li>
<li><a href=/posts/knowledge/2008-elasticstack-es/ title=Elasticsearch>Elasticsearch</a></li>
<li><a href=/posts/knowledge/2009-kubernetes-handless-statefullset/ title=k8s中通过Headless连接StatefulSet>k8s中通过Headless连接StatefulSet</a></li>
</ul>
</li>
<li>
<i class="fas fa-plus-circle"></i><a href=/posts/deployment/>环境部署</a>
<ul>
<li><a href=/posts/deployment/3001-blog-cicd/ title=我的博客后端Docker镜像打包自动部署流程>我的博客后端Docker镜像打包自动部署流程</a></li>
<li><a href=/posts/deployment/3002-linux-nginx/ title=Linux部署Nginx流程>Linux部署Nginx流程</a></li>
<li><a href=/posts/deployment/3003-linux-traefik/ title=Traefik部署流程>Traefik部署流程</a></li>
<li><a href=/posts/deployment/3004-linux-grafana/ title=Grafana部署流程>Grafana部署流程</a></li>
<li><a href=/posts/deployment/3005-linux-prometheus/ title=Prometheus部署流程>Prometheus部署流程</a></li>
<li><a href=/posts/deployment/3006-linux-elk/ title=ELK部署流程>ELK部署流程</a></li>
<li><a href=/posts/deployment/3007-linux-kubernetes/ title=Linux部署Kubernetes流程>Linux部署Kubernetes流程</a></li>
</ul>
</li>
<li>
<i class="fas fa-plus-circle"></i><a href=/posts/algorithm/>算法</a>
<ul>
<li><a href=/posts/algorithm/4001-algorithm-sort/ title=排序算法>排序算法</a></li>
<li><a href=/posts/algorithm/4002-algorithm-trie/ title=前缀树>前缀树</a></li>
</ul>
</li>
<li>
<i class="fas fa-plus-circle"></i><a href=/posts/problems/>疑难杂症</a>
<ul>
<li><a href=/posts/problems/5001-go-online-service-oom/ title=记一次线上的内存持续增长问题>记一次线上的内存持续增长问题</a></li>
<li><a href=/posts/problems/5002-k8s-memory/ title=Grafana上监控不准问题排查>Grafana上监控不准问题排查</a></li>
<li><a href=/posts/problems/5003-elasticsearch-start-failed/ title=CentOS安装完ES无法启动>CentOS安装完ES无法启动</a></li>
<li><a href=/posts/problems/5004-kubernetes-dashboard-token/ title="k8s dashboard token过期时间太短">k8s dashboard token过期时间太短</a></li>
<li><a href=/posts/problems/5005-docker-image-source/ title=修改Docker镜像源>修改Docker镜像源</a></li>
</ul>
</li>
<li>
<i class="fas fa-plus-circle"></i><a href=/posts/unclassified/>未分类</a>
<ul>
<li><a href=/posts/unclassified/6001-markdown/ title="Markdown Sample">Markdown Sample</a></li>
</ul>
</li>
</div>
</ul>
</div>
</div>
</div>
</section>
<section class=content-section id=content-section>
<div class=content>
<div class="container p-0 read-area">
<div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://ormissia.github.io/posts/knowledge/2001-go-partten-1/head.svg)>
</div>
<div class=page-content>
<div class="author-profile ml-auto align-self-lg-center">
<img class=rounded-circle src=/images/avatar_hu6760e73bd186896e9f58f2b8b663dec5_93204_120x120_fit_box_3.png alt="Author Image">
<h5 class=author-name>Ormissia</h5>
<p>July 22, 2021</p>
</div>
<div class=title>
<h1>Go 惯用模式：函数选项模式</h1>
</div>
<div class=post-content id=post-content>
<hr>
<p><img src=https://img.shields.io/badge/-Golang-blue alt=Golang>
<img src=https://img.shields.io/badge/-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-green alt=设计模式></p>
<hr>
<blockquote>
<p>作为 Golang 开发者，遇到的许多问题之一就是尝试将函数的参数设置成可选项。这是一个十分常见的场景，您可以使用一些已经设置默认配置和开箱即用的对象，同时您也可以使用一些更为详细的配置。</p>
</blockquote>
<h2 id=问题出发点>问题出发点</h2>
<p>对于许多编程语言来说，这很容易。在 C 语言家族中，您可以提供具有同一个函数但是不同参数的多个版本；在 PHP 之类的语言中，您可以为参数提供默认值，并在调用该方法时将其忽略。但是在 Golang 中，上述的做法都不可以使用。那么您如何创建具有一些其他配置的函数，用户可以根据他的需求（但是仅在需要时）指定一些额外的配置。</p>
<p>有很多的方法可以做到这一点，但是大多数方法都不是尽如人意，要么需要在服务端的代码中进行大量额外的检查和验证，要么通过传入他们不关心的其他参数来为客户端进行额外的工作。</p>
<p>下面我将会介绍一些不同的选项，然后为其说明为什么每个选项都不理想，接着我们会逐步构建自己的方式来作为最终的干净解决方案：函数选项模式。</p>
<p>让我们来看一个例子。比方说，这里有一个叫做<code>StuffClient</code>的服务，它能够胜任一些工作，同时还具有两个配置选项（超时和重试）。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClient</span> <span style=color:#66d9ef>interface</span> {
    <span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span>
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>stuffClient</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>conn</span>    <span style=color:#a6e22e>Connection</span>
    <span style=color:#a6e22e>timeout</span> <span style=color:#66d9ef>int</span>
    <span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>
}
</code></pre></div><p>这是个私有的结构体，因此我们应该为它提供某种构造函数：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>timeout</span>, <span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClient</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>timeout</span>,
        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>retries</span>,
    }
}
</code></pre></div><p>嗯，但是现在我们每次调用<code>NewStuffClient</code>函数时都要提供<code>timeout</code>和<code>retries</code>。因为在大多数情况下，我们只想使用默认值，我们无法使用不同参数数量带定义多个版本的<code>NewStuffClient</code>，否则我们会得到一个类似<code>NewStuffClient redeclared in this block</code>编译错误。</p>
<p>一个可选方案是创建另一个具有不同名称的构造函数，例如：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>) <span style=color:#a6e22e>StuffClient</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>DEFAULT_TIMEOUT</span>,
        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>DEFAULT_RETRIES</span>,
    }
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClientWithOptions</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>timeout</span>, <span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClient</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>timeout</span>,
        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>retries</span>,
    }
}
</code></pre></div><p>但是这么做的话有点蹩脚。我们可以做得更好，如果我们传入了一个配置对象呢:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOptions</span> <span style=color:#66d9ef>struct</span> {
    <span style=color:#a6e22e>Retries</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//number of times to retry the request before giving up
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>Timeout</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//connection timeout in seconds
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>options</span> <span style=color:#a6e22e>StuffClientOptions</span>) <span style=color:#a6e22e>StuffClient</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Timeout</span>,
        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Retries</span>,
    }
}
</code></pre></div><p>但是，这也不是很好的做法。现在，我们总是需要创建<code>StuffClientOption</code>这个结构体，即使不想在指定任何选项时还要传递它。另外我们也没有自动填充默认值，除非我们在代码中的某处添加了一堆检查，或者也可以传入一个<code>DefaultStuffClientOptions</code>变量（不过这么做也不好，因为在修改某一处地方后可能会导致其他的问题。）</p>
<p>所以，更好的解决方法是什么呢？解决这个难题最好的解决方法是使用函数选项模式，它利用了<code>Go</code>对闭包更加方便的支持。让我们保留上述定义的<code>StuffClientOptions</code>，不过我们仍需要为其添加一些内容。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOption</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>)
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOptions</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Retries</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//number of times to retry the request before giving up
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Timeout</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//connection timeout in seconds
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithRetries</span>(<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>) {
		<span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>Retries</span> = <span style=color:#a6e22e>r</span>
	}
}
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>t</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>) {
		<span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>Timeout</span> = <span style=color:#a6e22e>t</span>
	}
}
</code></pre></div><p>泥土般芬芳, 不是吗？这到底是怎么回事？基本上，我们有一个结构来定义<code>StuffClient</code>的可用选项。另外，现状我们还定义了一个叫做<code>StuffClientOption</code>的东西（次数是单数），它只是接受我们选项的结构体作为参数的函数。我们还定义了另外两个函数 WithRetries 和<code>WithTimeout</code>，它们返回一个闭包，现在就是见证奇迹的时刻了！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>defaultStuffClientOptions</span> = <span style=color:#a6e22e>StuffClientOptions</span>{
    <span style=color:#a6e22e>Retries</span>: <span style=color:#ae81ff>3</span>,
    <span style=color:#a6e22e>Timeout</span>: <span style=color:#ae81ff>2</span>,
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>StuffClientOption</span>) <span style=color:#a6e22e>StuffClient</span> {
    <span style=color:#a6e22e>options</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>defaultStuffClientOptions</span>
    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>o</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>opts</span> {
        <span style=color:#a6e22e>o</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>options</span>)
    }
    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Timeout</span>,
        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Retries</span>,
    }
}
</code></pre></div><p>现在，我们定义了一个额外和包含默认选项的没有导出的变量，同时我们已经调整了构造函数，用来接收可变参数。然后, 我们遍历<code>StuffClientOption</code>列表(单数)，针对每一个列表，将列表中返回的闭包使用在我们的<code>options</code>变量（需要记住，这些闭包接收一个<code>StuffClientOptions</code>变量，仅需要在选项的值上做出少许修改）。</p>
<p>现在我们要做的事情就是使用它！</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>Connection</span>{})
<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>x</span>) <span style=color:#75715e>// prints &amp;{{} 2 3}
</span><span style=color:#75715e></span><span style=color:#a6e22e>x</span> = <span style=color:#a6e22e>NewStuffClient</span>(
    <span style=color:#a6e22e>Connection</span>{},
    <span style=color:#a6e22e>WithRetries</span>(<span style=color:#ae81ff>1</span>),
)
<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>x</span>) <span style=color:#75715e>// prints &amp;{{} 2 1}
</span><span style=color:#75715e></span><span style=color:#a6e22e>x</span> = <span style=color:#a6e22e>NewStuffClient</span>(
    <span style=color:#a6e22e>Connection</span>{},
    <span style=color:#a6e22e>WithRetries</span>(<span style=color:#ae81ff>1</span>),
    <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#ae81ff>1</span>),
)
<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>x</span>) <span style=color:#75715e>// prints &amp;{{} 1 1}
</span></code></pre></div><h2 id=函数选项模式>函数选项模式</h2>
<p>这看起来相当不错，已经可以使用了！而且，它的好处是，我们只需要对代码进行很少的修改，就可以随时随地添加新的选项。</p>
<p>把这些修改放在一起，就是这样：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>defaultStuffClientOptions</span> = <span style=color:#a6e22e>StuffClientOptions</span>{
	<span style=color:#a6e22e>Retries</span>: <span style=color:#ae81ff>3</span>,
	<span style=color:#a6e22e>Timeout</span>: <span style=color:#ae81ff>2</span>,
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOption</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>)
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOptions</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Retries</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//number of times to retry the request before giving up
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Timeout</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//connection timeout in seconds
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithRetries</span>(<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>) {
		<span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>Retries</span> = <span style=color:#a6e22e>r</span>
	}
}
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>t</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>) {
		<span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>Timeout</span> = <span style=color:#a6e22e>t</span>
	}
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClient</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span>
}
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>stuffClient</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>conn</span>    <span style=color:#a6e22e>Connection</span>
	<span style=color:#a6e22e>timeout</span> <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>
}
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Connection</span> <span style=color:#66d9ef>struct</span>{}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>StuffClientOption</span>) <span style=color:#a6e22e>StuffClient</span> {
	<span style=color:#a6e22e>options</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>defaultStuffClientOptions</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>o</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>opts</span> {
		<span style=color:#a6e22e>o</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>options</span>)
	}
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
		<span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
		<span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Timeout</span>,
		<span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Retries</span>,
	}
}
<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>stuffClient</span>) <span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}

</code></pre></div><p>但这也可以通过删除<code>StuffClientOptions</code>结构体进一步简化，并将选项直接应用在我们的<code>StuffClient</code>上。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>defaultStuffClient</span> = <span style=color:#a6e22e>stuffClient</span>{
	<span style=color:#a6e22e>retries</span>: <span style=color:#ae81ff>3</span>,
	<span style=color:#a6e22e>timeout</span>: <span style=color:#ae81ff>2</span>,
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOption</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>stuffClient</span>)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithRetries</span>(<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stuffClient</span>) {
		<span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>retries</span> = <span style=color:#a6e22e>r</span>
	}
}
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>t</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stuffClient</span>) {
		<span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>timeout</span> = <span style=color:#a6e22e>t</span>
	}
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClient</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span>
}
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>stuffClient</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>conn</span>    <span style=color:#a6e22e>Connection</span>
	<span style=color:#a6e22e>timeout</span> <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>
}
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Connection</span> <span style=color:#66d9ef>struct</span>{}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>StuffClientOption</span>) <span style=color:#a6e22e>StuffClient</span> {
	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>defaultStuffClient</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>o</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>opts</span> {
		<span style=color:#a6e22e>o</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>client</span>)
	}
	<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>conn</span> = <span style=color:#a6e22e>conn</span>
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>client</span>
}
<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>stuffClient</span>) <span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>在我们的示例中，我们只是将配置直接应用于结构体中，如果中间有一个额外的结构体是没有意义的。但是，请注意，在许多情况下，您可能仍然想使用上一个示例中的<code>config</code>结构。例如，如果您的构造函数正在使用<code>config</code>选项执行某些操作时，但是并没有将它们存储到结构体中，或者被传递到其他地方，配置结构的变体是更通用的实现。</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&mid=2651446914&idx=2&sn=399fd11dd859876482101323c8fda41c&chksm=80bb0070b7cc8966e61f0a56f8d1be9723d6f14474b0a49139782a5b7b95f2a1eb77e015f670&mpshare=1&scene=23&srcid=07213W7UjZWK0grKRigNtOnY&sharer_sharetime=1626876989247&sharer_shareid=67201e2b242a26eb3109d48964e2d089%23rd">转载自此处</a></p>
</div>
<div class="row pl-3 pr-3">
<div class="col-md-6 share-buttons">
<strong>分享:</strong>
<a class="btn btn-sm reddit-btn" href="https://reddit.com/submit?url=https%3a%2f%2formissia.github.io%2fposts%2fknowledge%2f2001-go-partten-1%2f&title=Go%20%e6%83%af%e7%94%a8%e6%a8%a1%e5%bc%8f%ef%bc%9a%e5%87%bd%e6%95%b0%e9%80%89%e9%a1%b9%e6%a8%a1%e5%bc%8f" target=_blank>
<i class="fab fa-reddit"></i>
</a>
<a class="btn btn-sm linkedin-btn" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2formissia.github.io%2fposts%2fknowledge%2f2001-go-partten-1%2f&title=Go%20%e6%83%af%e7%94%a8%e6%a8%a1%e5%bc%8f%ef%bc%9a%e5%87%bd%e6%95%b0%e9%80%89%e9%a1%b9%e6%a8%a1%e5%bc%8f" target=_blank>
<i class="fab fa-linkedin"></i>
</a>
<a class="btn btn-sm email-btn" href="mailto:?subject=Go%20%e6%83%af%e7%94%a8%e6%a8%a1%e5%bc%8f%ef%bc%9a%e5%87%bd%e6%95%b0%e9%80%89%e9%a1%b9%e6%a8%a1%e5%bc%8f&body=https%3a%2f%2formissia.github.io%2fposts%2fknowledge%2f2001-go-partten-1%2f" target=_blank>
<i class="fas fa-envelope-open-text"></i>
</a>
</div>
<div class="col-md-6 btn-improve-page">
<a href=https://github.com/ormissia/ormissia.github.io/edit/master/content/posts/knowledge/2001-go-partten-1/index.md title=改善此页面 target=_blank rel=noopener>
<i class="fas fa-code-branch"></i>
改善此页面
</a>
</div>
</div>
<hr>
<div class="row next-prev-navigator">
<div class="col-md-12 next-article">
<a href=/posts/knowledge/2002-go-param-verify/ title="Golang 实体参数校验" class="btn btn-outline-info">
<div>下一篇 <i class="fas fa-chevron-circle-right"></i></div>
<div class=next-prev-text>Golang 实体参数校验</div>
</a>
</div>
</div>
<hr>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement("script"),a.type="text/javascript",a.async=!0,b="ormissia-github-io-posts",a.src="//"+b+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})()</script>
<noscript>请启用 JavaScript 以查看
<a href=https://disqus.com/?ref_noscript>评论支持 by Disqus.</a></noscript>
<a href=https://disqus.com/ class=dsq-brlink>评论支持 by <span class=logo-disqus>Disqus</span></a>
</div>
</div>
</div>
<a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a>
</section>
<section class=toc-section id=toc-section>
<div class=toc-holder>
<h5 class="text-center pl-3">目录</h5>
<hr>
<div class=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#问题出发点>问题出发点</a></li>
<li><a href=#函数选项模式>函数选项模式</a></li>
</ul>
</nav>
</div>
</div>
</section>
</div>
<footer class="container-fluid text-center align-content-center footer pb-2">
<div class="container pt-5">
<div class="row text-left">
<div class="col-md-4 col-sm-12">
<h5>联系方式:</h5>
<ul>
<li><span>QQ: </span> <span>1432050813</span></li>
<li><span>Email: </span> <span>ormissia@outlook.com</span></li>
</ul>
</div>
</div>
</div>
<hr>
<div class=container>
<p id=disclaimer><strong>免责声明:</strong> 老铁看到底了，要负责的哦</p>
</div>
<hr>
<div class=container>
<div class="row text-left">
<div class=col-md-4>
<a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener>
<img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha
</a>
</div>
<div class="col-md-4 text-center">© 2021 Copyright.</div>
<div class="col-md-4 text-right">
<a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18>
</a>
</div>
</div>
</div>
</footer>
<script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>